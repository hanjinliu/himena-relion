# Create External Jobs

RELION has a built-in job called "External" that can run any command as a RELION job.
This means that if you define the proper wrapper for the command you want to use, you
can easily extend RELION.

## Class Structure

All the subclasses of `RelionExternalJob` will be registered as external jobs. The
subclasses must implement `output_nodes()` and `run()`.

```python
from himena_relion.external import RelionExternalJob

class MyJob(RelionExternalJob):
    def output_nodes(self):
        return [
            ("output-particles.star", "ParticleGroupMetadata.star"),
            ("output-density.mrc", "DensityMap.mrc"),
        ]

    def run(
        self,
        in_3dref,
        in_parts,
        some_param: float,
    ):
        # do something with the input files and parameters

```

- `output_nodes()` should return a list of (output file name, node type) pairs. The
  output file name is relative to the job directory. `RelionExternalJob` will **trust**
  the output files to be generated by the `run()` method and will not check the
  implementation sanity. The node type should be one of the node types that RELION can
  interpret.
- `run()` should implement the logic of the job. To make the job abortable, `run()`
  should be a generator function in which `yield` statement is inserted at the
  checkpoints.
  Following variables are useful for the implementation:
  - `self.out_job_dir` *Path* ... path to the job directory.
  - `self.console` *rich.console.Console* ... a console object for printing messages to
    the user. `self.console.log("xyz")` will print "xyz" to the run.out file.

### Job Title

To make the job more informative, you can override the `job_title()` class method to provide a custom job title.

```python
from himena_relion.external import RelionExternalJob

class MyJob(RelionExternalJob):
    ...

    @classmethod
    def job_title(cls):
        return "My Job"
```

### Parameter types

To provide the user interface for the job parameters, `himena-relion` uses the type-to-widget mapping functionality built by [`magicgui`](https://pyapp-kit.github.io/magicgui/), with restrictions on the types so that the job parameters can be safely
serialized to and deserialized from a job.star file.

### The reserved parameter names

Following parameter names are reserved for RELION and can be used in the `run()` method.

- `in_3dref` ... Reference map
- `in_coords` ... Picked particle coordinates
- `in_mask` ... Mask
- `in_mics` ... Micrographs
- `in_movies` ... Movies
- `in_parts` ... Particles
- `j` ... Number of threads to use

## Widget For Your Job

```python
class MyJob(RelionExternalJob):
    ...

    def provide_widget(self, job_dir):
        return QMyJobWidget(job_dir)
```

## Test Your Job

```bash
himena relion --install myjob.py
```

## Distribute as a plugin

```toml title="pyproject.toml"
[project.entry-points."himena.plugin"]
"My RELION Plugin" = mymodule.mysubmodule.myjob
```
